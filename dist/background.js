async function a(){const e=await chrome.tabs.query({}),o={};e.forEach(r=>{const t=new URL(r.url).hostname;o[t]||(o[t]=[]),o[t].push(r.id)});for(const[r,t]of Object.entries(o))t.length>1&&(await chrome.tabs.group({tabIds:t}),await chrome.tabGroups.update(t[0],{title:r}),console.log(`Created group for ${r} with ${t.length} tabs`))}async function l(){const e=await chrome.tabs.query({active:!1}),o=Date.now(),r=30*60*1e3;e.forEach(async t=>{o-t.lastAccessed>r&&(await chrome.tabs.discard(t.id),console.log(`Suspended inactive tab: ${t.title}`))})}async function u(){const e=await chrome.tabs.query({}),o=new Map;e.forEach(r=>{o.has(r.url)?(chrome.tabs.remove(r.id),console.log(`Closed duplicate tab: ${r.title}`)):o.set(r.url,r.id)})}console.log("TabSmart background script loaded");let i=null,c={width:300,height:600},s=null;chrome.runtime.onInstalled.addListener(()=>{console.log("TabSmart installed"),chrome.storage.local.set({isPinned:!1,focusModeEnabled:!1,suspendedTabs:[],tabNotes:{}})});chrome.runtime.onMessage.addListener((e,o,r)=>(console.log("Background script received message:",e),e.action==="togglePin"?(p(e.isPinned,e.tabId),r({success:!0})):e.action==="savePopupSize"?(c={width:e.width,height:e.height},r({success:!0})):e.action==="groupSimilarTabs"?(a(),r({success:!0})):e.action==="suspendInactiveTabs"?(l(),r({success:!0})):e.action==="detectDuplicateTabs"?(u(),r({success:!0})):e.action==="toggleFocusMode"&&(f(),r({success:!0})),!0));function p(e,o){e?chrome.windows.getCurrent(r=>{const t=c.width,d=c.height,m=r.left+r.width-t-20,h=r.top+20;chrome.windows.create({url:chrome.runtime.getURL("index.html"),type:"popup",width:t,height:d,left:m,top:h,focused:!0},n=>{i=n.id,s=o,chrome.windows.update(n.id,{state:"normal",focused:!0},()=>{chrome.runtime.lastError&&console.error("Error updating window:",chrome.runtime.lastError)}),chrome.action.setPopup({tabId:o,popup:""},()=>{chrome.runtime.lastError&&console.error("Error setting popup:",chrome.runtime.lastError)})})}):i&&chrome.windows.remove(i,()=>{chrome.runtime.lastError?console.error("Error removing window:",chrome.runtime.lastError):(i=null,chrome.action.setPopup({tabId:s,popup:"index.html"},()=>{chrome.runtime.lastError&&console.error("Error restoring popup:",chrome.runtime.lastError),s=null}))}),chrome.storage.local.set({isPinned:e},()=>{chrome.runtime.lastError&&console.error("Error setting isPinned:",chrome.runtime.lastError)})}chrome.tabs.onActivated.addListener(e=>{i&&s&&e.tabId===s&&chrome.windows.update(i,{focused:!0},()=>{chrome.runtime.lastError&&console.error("Error focusing pinned window:",chrome.runtime.lastError)})});function f(){chrome.storage.local.get("focusModeEnabled",e=>{if(chrome.runtime.lastError){console.error("Error getting focusModeEnabled:",chrome.runtime.lastError);return}const o=!e.focusModeEnabled;chrome.storage.local.set({focusModeEnabled:o},()=>{if(chrome.runtime.lastError){console.error("Error setting focusModeEnabled:",chrome.runtime.lastError);return}const r={type:"basic",iconUrl:chrome.runtime.getURL("icons/icon128.png"),title:o?"Focus Mode Enabled":"Focus Mode Disabled",message:o?"Stay focused! Distracting websites are now blocked.":"Focus Mode has been turned off."};chrome.notifications.create(r,t=>{chrome.runtime.lastError&&console.error("Error creating notification:",chrome.runtime.lastError)})})})}chrome.alarms.create("periodicTasks",{periodInMinutes:15});chrome.alarms.onAlarm.addListener(e=>{e.name==="periodicTasks"&&(a().catch(o=>console.error("Error grouping similar tabs:",o)),l().catch(o=>console.error("Error suspending inactive tabs:",o)),u().catch(o=>console.error("Error detecting duplicate tabs:",o)))});
